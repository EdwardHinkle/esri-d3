<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=7,IE=9" />
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no"/>
    <title>Esri <3 d3js</title>
    <link rel="stylesheet" href="http://serverapi.arcgisonline.com/jsapi/arcgis/3.3/js/esri/css/esri.css">
    <style type="text/css">
      html, body { 
        height: 100%; width: 100%;
        margin: 0; padding: 0;
      } 
      body{
        background-color: #fff; overflow:hidden; 
        font-family: sans-serif;
      }
      #map {
        position:absolute;
        width: 100%;
        height: 100%;
      }

    </style>
    <script>
      var dojoConfig = {
        parseOnLoad: true,
        packages: [{
          "name": "modules",
          "location": location.origin + location.pathname.replace(/\/[^/]+$/, '')
        }]
      };
    </script>
   
    <script src="http://serverapi.arcgisonline.com/jsapi/arcgis/3.3/"></script>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script>

      dojo.require("esri.map");
      dojo.require("modules.d3Layer");
      dojo.ready(function(){
  
        var initExtent = new esri.geometry.Extent({"xmin":-132,"ymin":20,"xmax":-60,"ymax":50,"spatialReference":{"wkid":4326}});
        map = new esri.Map("map",{
          extent:esri.geometry.geographicToWebMercator(initExtent)
        });

        var basemap = new esri.layers.ArcGISTiledMapServiceLayer("http://services.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer");
        map.addLayer(basemap); 

        d3.json('data/mlb_logos.json', function( logos ){
          var svg = d3.select( 'body' )
                .append('svg')
                .attr('width', 1000)
                .attr('height', 1000);
          var defs = svg.append('svg:defs');

          logos.forEach(function( logo ){
            defs.append('svg:pattern')
                .attr('id', logo.team)
                .attr('patternUnits', 'userSpaceOnUse')
                .attr('width', 68)//logo.sym.width+'')
                .attr('height', 68) //logo.sym.height+'')
                .append('svg:image')
                .attr('xlink:href', 'http://bearpanther.com/mlb-layer/divisions-web-mercator/'+logo.sym.url)
                //.attr('x', '10%')
                //.attr('y', '10%')
                .attr('transform', 'translate(0,0)')
                .attr('width', 48)
                .attr('height', 48); //transform="translate(-35.5,-31)
          }); 
       
          var layer = new modules.d3Layer('data/mlb_salaries.json', {
            attrs: [
              { key: 'r', value: '27' },
              { key: 'class', value: 'park' }
            ],
            events: [
              { key: 'mouseover', value: select}
            ],
            styles: [
              { key: 'fill', value: function( d ){ return 'url(#'+d.properties.team.name+') no-repeat'; } }
            ],
            type: 'circle'
          }); 
          map.addLayer(layer);
 
          dojo.connect(layer, "onLoad", function(lyr) {
            lyr._render();
          });

          d3.selectAll('.park')
            .on('mouseover', function(){
              console.log('mouseover');
            })

        })

    
      });

      function select( ){
        console.log( arguments )
      }
    </script>
  </head>
  <body class="tundra">
    <div id="map"></div>
    <div id="css"></div>
  </body>
</html>
